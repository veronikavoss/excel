<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV ë³€í™˜ ë„êµ¬ (ì¼ê´„ ì²˜ë¦¬)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", helvetica, "Apple SD Gothic Neo", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 30px;
            width: 100%;
            max-width: 600px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
        }
        
        /* [ì¶”ê°€] ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ */
        #dropZone {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #fafafa;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #dropZone.dragover {
            background-color: #e8f0fe;
            border-color: #007bff;
        }
        #dropZone p {
            color: #666;
            font-size: 1.1rem;
            margin: 0 0 20px 0;
        }
        
        /* [ì¶”ê°€] ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn {
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #fileSelectBtn {
            background-color: #5c677d;
            color: white;
        }
        #fileSelectBtn:hover { background-color: #495366; }
        
        #folderSelectBtn {
            background-color: #5c677d;
            color: white;
        }
        #folderSelectBtn:hover { background-color: #495366; }

        /* [ì¶”ê°€] ìˆ¨ê²¨ì§„ input íƒœê·¸ë“¤ */
        .hidden-input {
            display: none;
        }
        
        /* ë³€í™˜ ë²„íŠ¼ */
        #convertButton {
            width: 100%;
            padding: 15px;
            margin-top: 25px;
            font-size: 1.1rem;
            background-color: #007bff;
            color: white;
        }
        #convertButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* ë¡œê·¸ */
        #log {
            margin-top: 20px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            font-family: "Courier New", Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 50px;
            font-size: 0.9rem;
            color: #444;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>CSV ë§¤í•‘ íˆ´ ğŸ“‘</h1>
        
        <div id="dropZone">
            <p>ì—¬ê¸°ë¡œ íŒŒì¼ì´ë‚˜ í´ë”ë¥¼ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
            <div class="button-group">
                <button type="button" id="fileSelectBtn" class="btn">ğŸ“„ íŒŒì¼ ì„ íƒ</button>
                <button type="button" id="folderSelectBtn" class="btn">ğŸ“ í´ë” ì„ íƒ</button>
            </div>
        </div>

        <input type="file" id="fileInput" class="hidden-input" accept=".csv" multiple>
        <input type="file" id="folderInput" class="hidden-input" webkitdirectory directory>

        <button id="convertButton" class="btn" disabled>ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ</button>

        <pre id="log">1. íŒŒì¼ì´ë‚˜ í´ë”ë¥¼ ì„ íƒ/ë“œë¡­í•˜ì„¸ìš”.</pre>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileSelectBtn = document.getElementById('fileSelectBtn');
        const folderSelectBtn = document.getElementById('folderSelectBtn');
        const fileInput = document.getElementById('fileInput');
        const folderInput = document.getElementById('folderInput');
        const convertButton = document.getElementById('convertButton');
        const logEl = document.getElementById('log');

        let filesToProcess = []; // [ìˆ˜ì •] ì²˜ë¦¬í•  íŒŒì¼ ëª©ë¡ì„ ì €ì¥í•  ë°°ì—´

        // --- 1. ì…ë ¥ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë²„íŠ¼, ë“œë˜ê·¸ ì•¤ ë“œë¡­) ---

        // 'íŒŒì¼ ì„ íƒ' ë²„íŠ¼ í´ë¦­
        fileSelectBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            handleFileSelection(fileInput.files);
        });

        // 'í´ë” ì„ íƒ' ë²„íŠ¼ í´ë¦­
        folderSelectBtn.addEventListener('click', () => folderInput.click());
        folderInput.addEventListener('change', () => {
            handleFileSelection(folderInput.files);
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); // ì „ì²´ í™”ë©´ ë“œë¡­ ë°©ì§€
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        // ë“œë¡­ ì²˜ë¦¬
        dropZone.addEventListener('drop', handleDrop, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        async function handleDrop(e) {
            const items = e.dataTransfer.items;
            let files = [];

            if (items) {
                // [ì‹ ê·œ] ë“œë¡­ëœ í•­ëª©(íŒŒì¼/í´ë”)ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ìŠ¤ìº”
                const scanPromises = [];
                for (let i = 0; i < items.length; i++) {
                    const entry = items[i].webkitGetAsEntry();
                    if (entry) {
                        scanPromises.push(scanFileEntry(entry));
                    }
                }
                const nestedFiles = await Promise.all(scanPromises);
                files = nestedFiles.flat(Infinity); // ëª¨ë“  ì¤‘ì²© ë°°ì—´ì„ 1ì°¨ì›ìœ¼ë¡œ í¼ì¹¨
            } else {
                // í´ë” ìŠ¤ìº”ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ì˜ˆ: Firefox)
                files = Array.from(e.dataTransfer.files);
            }
            
            handleFileSelection(files);
        }
        
        // [ì‹ ê·œ] íŒŒì¼/í´ë” ì—”íŠ¸ë¦¬ ìŠ¤ìº” (ì¬ê·€)
        function scanFileEntry(entry) {
            return new Promise((resolve, reject) => {
                if (entry.isFile) {
                    entry.file(file => resolve(file), reject);
                } else if (entry.isDirectory) {
                    const reader = entry.createReader();
                    reader.readEntries(async (entries) => {
                        const results = await Promise.all(entries.map(scanFileEntry));
                        resolve(results.flat());
                    }, reject);
                } else {
                    resolve(null); // ì•Œ ìˆ˜ ì—†ëŠ” í•­ëª©
                }
            });
        }
        
        // [ì‹ ê·œ] íŒŒì¼ ëª©ë¡ ì²˜ë¦¬ (ê³µí†µ ë¡œì§)
        function handleFileSelection(fileList) {
            // FileListë‚˜ ë°°ì—´ì„ File ê°ì²´ì˜ ë°°ì—´ë¡œ ë³€í™˜
            filesToProcess = Array.from(fileList).filter(file => 
                file && file.name.toLowerCase().endsWith('.csv')
            );
            
            const fileCount = filesToProcess.length;
            
            if (fileCount > 0) {
                log(`[${fileCount}ê°œ CSV íŒŒì¼]ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.\n\n- ${filesToProcess.map(f => f.name).slice(0,10).join('\n- ')}\n${fileCount > 10 ? '... ì™¸ ë‹¤ìˆ˜' : ''}\n\n'ë³€í™˜' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.`);
                convertButton.disabled = false;
            } else {
                log('ğŸ”´ ì„ íƒëœ íŒŒì¼/í´ë” ì¤‘ì— ì²˜ë¦¬í•  `.csv` íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                convertButton.disabled = true;
            }
        }

        // --- 2. ë³€í™˜ ë¡œì§ ---

        convertButton.addEventListener('click', runConversion);

        async function runConversion() {
            if (filesToProcess.length === 0) {
                log('ğŸ”´ ì˜¤ë¥˜: ë³€í™˜í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            log(`ğŸ”„ ì´ ${filesToProcess.length}ê°œ íŒŒì¼ ì²˜ë¦¬ ì¤‘...`);
            convertButton.disabled = true;

            try {
                const zip = new JSZip();
                let csvFileCount = 0;
                
                for (const file of filesToProcess) {
                    try {
                        log(`... '${file.name}' íŒŒì¼ ë³€í™˜ ì¤‘ ...`);
                        const text = await readFileAsText(file);
                        const convertedCsv = processCSV(text);
                        const newFileName = `í‘œì¤€ì„œì‹_${file.name}`;
                        
                        const bom = '\uFEFF'; // UTF-8 BOM
                        zip.file(newFileName, bom + convertedCsv);
                        csvFileCount++;
                    } catch (fileError) {
                        log(`ğŸ”´ '${file.name}' ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${fileError.message}`);
                    }
                }

                if (csvFileCount > 0) {
                    log(`ğŸ”„ ${csvFileCount}ê°œ CSV íŒŒì¼ ë³€í™˜ ì™„ë£Œ. ZIP íŒŒì¼ ìƒì„± ì¤‘...`);
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    downloadBlob(zipBlob, 'í‘œì¤€ì„œì‹_ì¼ê´„ë³€í™˜.zip');
                    log(`âœ… ${csvFileCount}ê°œ íŒŒì¼ ì¼ê´„ ë³€í™˜ ì™„ë£Œ! 'í‘œì¤€ì„œì‹_ì¼ê´„ë³€í™˜.zip' íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.`);
                } else {
                    log('ğŸ”´ ë³€í™˜ì— ì„±ê³µí•œ CSV íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                log(`ğŸ”´ ì „ì²´ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error(error);
            } finally {
                convertButton.disabled = false;
                // [ìˆ˜ì •] ì‘ì—… ì™„ë£Œ í›„ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
                filesToProcess = [];
                // ì…ë ¥ í•„ë“œ ê°’ ì´ˆê¸°í™” (ë‹¤ìŒì— ê°™ì€ íŒŒì¼/í´ë”ë¥¼ ë˜ ì„ íƒí•  ìˆ˜ ìˆë„ë¡)
                fileInput.value = null;
                folderInput.value = null;
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsText(file, 'UTF-8'); // UTF-8ë¡œ ì½ê¸°
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error(`'${file.name}' íŒŒì¼ ì½ê¸° ì‹¤íŒ¨`));
            });
        }
        
        /**
         * [ ì¤‘ìš”! ë§ì¶¤ ì„¤ì • ì˜ì—­ ]
         * ì›ë³¸ 'ì—…ì¢…'ì„ 'ê³„ì •ê³¼ëª©'ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê·œì¹™ì…ë‹ˆë‹¤.
         */
        function getAccountTitle(category) {
            if (category.includes('ë§ˆíŠ¸') || category.includes('ì¡í™”ì ') || category.includes('í¸ì˜ì ')) {
                return 'ì†Œëª¨í’ˆë¹„';
            }
            if (category.includes('í•œì‹') || category.includes('ìŒë£Œ') || category.includes('ì»¤í”¼')) {
                return 'ë³µë¦¬í›„ìƒë¹„';
            }
            if (category.includes('í†µì‹ ë¹„')) {
                return 'í†µì‹ ë¹„';
            }
            return 'ì¡ë¹„'; // ê¸°ë³¸ê°’
        }

        // CSV ì²˜ë¦¬ ë¡œì§
        function processCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            
            if (lines.length < 2) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ í—¤ë”ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.');

            const rawHeaderLine = lines[0].trim();
            const rawHeaders = rawHeaderLine.split(',').map(h => h.replace(/"/g, ''));

            const colIndex = {
                ì„±ëª…: rawHeaders.indexOf('ì„±ëª…'),
                ì¹´ë“œë²ˆí˜¸: rawHeaders.indexOf('ì¹´ë“œë²ˆí˜¸'),
                ì´ìš©ì¼: rawHeaders.indexOf('ì´ìš©ì¼'),
                'ì´ìš©ê¸ˆì•¡(ì›)': rawHeaders.indexOf('ì´ìš©ê¸ˆì•¡(ì›)'),
                ê°€ë§¹ì ëª…: rawHeaders.indexOf('ê°€ë§¹ì ëª…'),
                ì—…ì¢…: rawHeaders.indexOf('ì—…ì¢…')
            };

            for (const key in colIndex) {
                if (colIndex[key] === -1) {
                    throw new Error(`í•„ìˆ˜ ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '${key}'`);
                }
            }
            
            const outputHeader = [
                "ë…„ë„ì›”ì¼   (ìˆ«ì8)", "êµ¬ ë¶„  (ìˆ«ì1)", "ì½”ë“œ", "ê³„ì •ê³¼ëª©", "ê±°ë˜ì²˜ì½”ë“œ",
                "\"ê±° ë˜ ì²˜ ëª…\n(30ìë¦¬)\"", "ì ìš”ì½”ë“œ", "ì   ìš”  ëª…", " ê¸ˆ    ì•¡",
                "\"ë¶€ì„œëª…\n(15ìë¦¬)\"", "\"ì‚¬ì›ëª…\n(15ìë¦¬)\"", "í˜„ì¥êµ¬ë¶„", "\"í˜„ì¥\nì½”ë“œ\"",
                "\"í˜„ ì¥ ëª…\n(25ìë¦¬)\"", "ê±°ë˜ì²˜êµ¬ë¶„", "\"ë“±ë¡,ê³„ì¢Œ,ì¹´ë“œë²ˆí˜¸\"",
                "\"ì—…   íƒœ\n(20ìë¦¬)\"", "\"ì¢…    ëª©\n(30ìë¦¬)\"", "ìš°í¸ë²ˆí˜¸",
                "\"ì£¼  ì†Œ\n(80ìë¦¬)\"", "\"ìƒ  ì„¸  ì£¼  ì†Œ\n(80ìë¦¬)\"", "ëŒ€í‘œì",
                "ë§¤ì…ì¹´ë“œì¼ë•Œì¹´ë“œìœ í˜•", "ì‹ ìš©ì¹´ë“œì‚¬ì½”ë“œ", "\"ì¹´ë“œì‚¬ìš©\nì—¬ë¶€\"",
                "\"í”„ë¡œì íŠ¸\nì½”ë“œ\"", "\" í”„ë¡œì íŠ¸ëª…\n(30ìë¦¬)\"", "\" ì¦ë¹™ë¶ˆë¹„ ì›ì¸\n(30ìë¦¬)\""
            ].join(',');

            const outputRows = [outputHeader];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === "") continue;

                const cols = line.split(',');
                if (cols.length < rawHeaders.length) continue;

                const rawDate = cols[colIndex.ì´ìš©ì¼];
                const rawCategory = cols[colIndex.ì—…ì¢…];
                const rawStoreName = cols[colIndex.ê°€ë§¹ì ëª…];
                const rawAmount = cols[colIndex['ì´ìš©ê¸ˆì•¡(ì›)']];
                const rawName = cols[colIndex.ì„±ëª…]; // 'ì„±ëª…' ì›ë³¸ ê°’
                const rawCardNum = cols[colIndex.ì¹´ë“œë²ˆí˜¸];

                if (!rawDate) continue; // ì´ìš©ì¼ì´ ì—†ëŠ” ë¹ˆ ì¤„ ë°©ì§€

                const newDate = rawDate.replace(/-/g, '');
                const accountTitle = getAccountTitle(rawCategory);
                const newCardNum = rawCardNum.replace('**', '-');
                
                let newRow = new Array(28).fill('');

                newRow[0] = newDate;
                newRow[1] = '3';
                newRow[3] = accountTitle;
                newRow[5] = rawStoreName;
                newRow[7] = rawStoreName;
                newRow[8] = rawAmount;
                newRow[10] = rawName; // 'ì„±ëª…' ì›ë³¸ê°’ ì‚¬ìš©
                newRow[15] = newCardNum;
                newRow[16] = rawCategory;
                newRow[17] = rawCategory;
                newRow[22] = 'ì‚¼ì„±ì¹´ë“œ';
                newRow[23] = 'ì‚¼ì„±ì¹´ë“œ';
                newRow[24] = '1';

                outputRows.push(newRow.join(','));
            }
            
            if (outputRows.length <= 1) throw new Error('ì²˜ë¦¬í•  ë°ì´í„° í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
            
            return outputRows.join('\n');
        }

        // Blob ë‹¤ìš´ë¡œë“œ í—¬í¼
        function downloadBlob(blob, fileName) {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>